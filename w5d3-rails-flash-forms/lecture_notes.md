# Rails `flash` and more about forms

They aren't actually related, but there's a good chance you'll use them together.

## The `flash`

* `flash` is closely related to `session`, but it's cleared on every request.
* It's normally used to store notification or error messages for operations that happen between requests (usually `create`, `update` and `delete` actions). 
* It kinda works like a hash - just like `session` - but Rails conventions recommend two special keys to be used:
  - `flash[:notice]` for success notifications or generic messages
  - `flash[:alert]` for error messages
  - This isn't enforced, so there's nothing stopping you from using `flash[:warning]` or `flash[:error]` for example.
* You can also set `flash` as part of a redirect
  - `redirect_to root_url, notice: "You have successfully logged out."`
  - `redirect_to root_url, alert: "You're stuck here!"`
  - `redirect_to root_url, flash: { referral_code: 1234 }`

Moar docs: http://guides.rubyonrails.org/action_controller_overview.html#the-flash

## Form helpers

There are two main ways to create a form with Rails: with or without attached models.

### `form_tag` - forms without models (basic forms)

* Examples of forms that don't need a model:
  - Search
  - Login
  - Any other situation where we're not editing a resource directly
* Start with `form_tag("/search", method: "get") do ... end`
* Use the various form helper methods to create form elements
  - `label_tag(:q, "Search for:")`
  - `text_field_tag(:q)`
  - `submit_tag("Search")`
* There are helpers for all common form elements:
  - `text_area_tag(:message, "Hi, nice site", size: "24x6")`
  - `password_field_tag(:password)`
  - `hidden_field_tag(:parent_id, "5")`
  - ...the list goes on

Reference: http://guides.rubyonrails.org/form_helpers.html#dealing-with-basic-forms

### `form_for` - forms with attached models

The main idea is the same, but you get some things for free. 

Let's say you create an instance on your controller:
```ruby
def new
  @article = Article.new
end
```

You can now do this on your `views/articles/new.html.erb`:
```erb
<%= form_for(@article) do |article| %>
  <%= article.text_field :title %>
  <%= article.text_area :body, size: "60x12" %>
  <%= article.submit "Create" %>
<% end %>
```

The form helpers are slightly different here. Instead of using `text_field_tag` we're using the `article` variable from the `form_for` block and calling form helpers on them. This means data will be filled automatically when `@article` isn't empty.

Note: this **only** works if you're using resourceful routes (i.e. `resources :articles` on your `config/routes.rb`). If you're not, your `form_for` tag will have to be more detailed:

```erb
<%= form_for @article, url: {action: "create"} do |f| %>
```

#### Forms with multiple models

Yes, it's possible. Use the `fields_for` helper to do it. This is pretty useful for models with relationships.

```erb
<%= form_for @person, url: {action: "create"} do |person_form| %>
  <%= person_form.text_field :name %>
  <%= fields_for @person.contact_detail do |contact_details_form| %>
    <%= contact_details_form.text_field :phone_number %>
  <% end %>
<% end %>
```

Reference: http://guides.rubyonrails.org/form_helpers.html#dealing-with-model-objects

### `params` in model forms

If you look at the HTML generated by model forms, you'll notice something strange:

```html
<input id="article_title" name="article[title]" type="text" />
<textarea id="article_body" name="article[body]" cols="60" rows="12"></textarea>
```

The field names are always in the format `model[field]`, where `model` is the object passed to `form_for` (or `fields_for`). Rails deals with this automatically in the controller and gives you clean `params`.

That's cool and all, but maybe you shouldn't be using `params` directly.

#### Strong parameters and mass assignment

If you've created a Rails scaffold, you've probably noticed a method like this on your controllers:
```ruby
def article_params
  params.require(:article).permit(:title, :text, :author_id)
end
```

This is a private method that filters `params` and removes any malicious data that might be present. Whenever you use `article_params` instead of plain `params`, two things will happen:

1. You'll **only** get data from fields following the `article[field]` naming convention (that's ensured by the `params.require(:article)` part)
2. Only the `title`, `text` and `author_id` fields will be present (that's the `permit()` part)

With this in place, you can do things like this without fear of getting trash data:

```ruby
@article = Article.new(article_params)
@article.save
```

The alternative would be...

```ruby
@article = Article.new({
  title: params[:title],
  text: params[:text],
  # ...
  # imagine if you had dozens of fields here...
})
@article.save
```

Reference: http://api.rubyonrails.org/classes/ActionController/StrongParameters.html

---
Code discussed in class:

https://www.dropbox.com/s/wq2od5kw2fmy2lr/w5d3-rails-flash-forms.tgz?dl=0
